<!DOCTYPE html>
<html lang="en">
<head>
{% include 'head_default.html' %}
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

<style>
  .dropzone {
    border: 2px dashed #ccc; border-radius: 6px;
    padding: 40px; text-align: center;
    cursor: pointer; color: #777;
  }
  .dropzone.dragover { background: #f0f8ff; }
</style>
</head>

<body>

{% include 'nav.html' %}

<div class="container">
  <div class="col-md-6">

    <form action="/ocr" method="POST" enctype="multipart/form-data" id="ocrForm">

      <h1>PDF → Google Vision OCR</h1>

      <!-- PDF input via drop zone -->
      <input type="file" name="pdf_file" id="fileInputPdf" accept=".pdf" style="display:none" required>
      <div class="dropzone" id="dropzone">
        <p>Drop a PDF here or click to select.</p>
      </div>

      <br>

      <!-- Google API key -->
      <div class="form-group">
          <label for="googleApiKeyMasked">
            Google Vision API key (required, see <a href="api_key_instructions" target="_blank">instructions</a>)
          </label>
          <input type="text"
                 id="googleApiKeyMasked"
                 class="form-control"
                 placeholder="•••••••••••••••••••••••••••••••••••••••••"
                 autocomplete="off"
                 required>
        </div>

      <!-- Page number option -->
      <div class="form-group">
          <div class="checkbox">
            <label>
              <input type="checkbox" name="include_page_numbers" value="yes" checked>
              Add extra page numbers in output (e.g. "=== 1 ===")
            </label>
          </div>
        </div>

      <!-- Display option -->
      <div class="form-group">
        <label>Where to get result:</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="display_inline" id="displayInline" value="yes" checked>
          <label class="form-check-label" for="displayInline">Show in browser</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="display_inline" id="downloadFile" value="no">
          <label class="form-check-label" for="downloadFile">Download file</label>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="progress" id="progressContainer" style="display: none;">
  <div class="progress-bar progress-bar-striped active"
       id="progressBar"
       role="progressbar"
       aria-valuenow="0"
       aria-valuemin="0"
       aria-valuemax="100"
       style="width: 0%;">
    0%
  </div>
</div>

      <p><input type="submit" value="Start OCR" class="btn btn-block btn-primary"></p>

      <h2>Tips</h2>
      <p>
          Files up to ~64 MB are accepted.

          You may wish to crop the individual pages of your PDF to get more relevant results.

          Use ASCII-only filenames to avoid problems.
      </p>

    </form>

  </div>
</div><!-- /.container -->

<script>
/* drop‑zone helper */

const dz   = document.getElementById('dropzone');
const file = document.getElementById('fileInputPdf');

dz.addEventListener('click', () => file.click());
file.addEventListener('change', () => dz.textContent = file.files[0].name);

dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    file.files = e.dataTransfer.files;
    dz.textContent = file.files[0].name;
  }
});

/* masked input for api key */

const maskedInput = document.getElementById("googleApiKeyMasked");
const form = document.getElementById("ocrForm");

let realValue = "";

maskedInput.addEventListener("input", (e) => {
const input = e.target;
const cursorPos = input.selectionStart;
const oldDisplay = input.value;
const newDisplay = "•".repeat(realValue.length);

// If pasted, replace selection
if (oldDisplay.length > newDisplay.length + 1) {
  const pastedText = oldDisplay.replace(/•/g, '');
  const before = realValue.slice(0, cursorPos - pastedText.length);
  const after = realValue.slice(cursorPos - pastedText.length);
  realValue = before + pastedText + after;
} else {
  const typedChar = e.data;
  const isDelete = !typedChar && input.value.length < realValue.length;

  if (isDelete) {
    realValue = realValue.slice(0, input.selectionStart) + realValue.slice(input.selectionEnd + 1);
  } else if (typedChar) {
    const before = realValue.slice(0, cursorPos - 1);
    const after = realValue.slice(cursorPos - 1);
    realValue = before + typedChar + after;
  }
}

input.value = "•".repeat(realValue.length);
input.setSelectionRange(realValue.length, realValue.length); // move cursor to end
});

form.addEventListener("submit", function () {
const hidden = document.createElement("input");
hidden.type = "hidden";
hidden.name = "google_api_key";
hidden.value = realValue;

maskedInput.disabled = true;
form.appendChild(hidden);
});

/* progress bar */

const fileInput = document.getElementById("fileInputPdf");
const progressBar = document.getElementById("progressBar");
const progressContainer = document.getElementById("progressContainer");

let progressInterval = null;
let startTime = null;
let estimatedTime = null;

form.addEventListener("submit", function () {
    const file = fileInput.files[0];
    if (!file) return;

    const estimatedPages = Math.max(1, Math.floor(file.size / (1024 * 100)));
    const estimatedTime = 22000 + Math.max(0, estimatedPages - 1) * 660;

    progressContainer.style.display = "block";
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";
    progressBar.setAttribute("aria-valuenow", "0");

    const startTime = Date.now();

    const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(99, (elapsed / estimatedTime) * 100);
        const display = Math.floor(progress);

        progressBar.style.width = `${display}%`;
        progressBar.textContent = `${display}%`;
        progressBar.setAttribute("aria-valuenow", display);
    }, 300);
});
</script>

</body>
</html>
