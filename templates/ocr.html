<!DOCTYPE html>
<html lang="en">
<head>
{% include 'head_default.html' %}
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
function downloadOcrText() {
  const text = document.getElementById("ocrText").value;
  const originalFile = fileInput.files[0] || window.selectedPdfFile;
  const baseName = originalFile ? originalFile.name.replace(/\.pdf$/i, '') : 'ocr_result';
  const blob = new Blob([text], { type: 'text/plain' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${baseName}_ocr_result.txt`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

<style>
  .dropzone {
    border: 2px dashed #ccc; border-radius: 6px;
    padding: 40px; text-align: center;
    cursor: pointer; color: #777;
  }
  .dropzone.dragover { background: #f0f8ff; }
  #ocrResultContainer {
    margin-top: 1em;
    display: none;
    padding-bottom: 6em;
    transform-origin: top;
  }
  .animate-zoom {
    animation: zoomInActual 0.3s ease-out forwards;
  }
  @keyframes zoomInActual {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .zoom-bounce {
    animation: bounceFill 300ms ease-out forwards;
  }
  @keyframes bounceFill {
    0%   { transform: scaleY(1); background-color: steelblue; }
    50%  { transform: scaleY(1.2); background-color: mediumseagreen; }
    100% { transform: scaleY(1); background-color: mediumseagreen; }
  }
  .error-state {
    background-color: indianred !important;
  }
  #copyButton,
  #downloadButton {
    min-width: 160px;
  }
</style>
</head>

<body>

{% include 'nav.html' %}

<div class="container">
  <div class="col-md-6" id="ocrForm">

    <h1>PDF â†’ Google Vision OCR</h1>

    <!-- PDF input via drop zone -->
    <input type="file" id="fileInputPdf" accept=".pdf" style="display:none" required>
    <div class="dropzone" id="dropzone">
      <p>Drop a PDF here or click to select.</p>
    </div>

    <br>

    <!-- Google API key -->
    <div class="form-group">
      <label for="googleApiKey">
        Google Vision API key (required, see <a href="api_key_instructions" target="_blank">instructions</a>)
      </label>
      <input type="password" id="googleApiKey" class="form-control"
             placeholder="Enter your Google Vision API key"
             name="google_api_key" autocomplete="current-password" required>
    </div>

    <h3>Options</h3>

    <!-- Page number option -->
    <div class="form-group">
      <div class="checkbox">
        <label>
          <input type="checkbox" id="includePageNumbers" checked>
          Add extra page numbers in output (e.g. "=== 1 ===")
        </label>
      </div>
    </div>

    <!-- Display option -->
    <div class="form-group">
      <label class="radio-inline">
        <input type="radio" name="display_style" id="displayInBrowser" value="yes" checked>
        Show result in browser
      </label>
      <label class="radio-inline">
        <input type="radio" name="display_style" id="downloadFile" value="no">
        Download result as .txt file
      </label>
    </div>

    <h3>Tips</h3>
    <p>
      Files up to <strong>~64 MB</strong> are supported. Larger files will fail.<br>
      Cropping your PDF pages may improve accuracy and performance.<br>
      Most OCR results contain some errors. Please review and clean up as needed.<br>
    </p>

    <!-- Progress bar -->
    <div class="progress" id="progressContainer" style="display: none;">
      <div class="progress-bar progress-bar-striped"
           id="progressBar"
           role="progressbar"
           aria-valuenow="0"
           aria-valuemin="0"
           aria-valuemax="100"
           style="width: 0%;">
        0%
      </div>
    </div>

    <div class="form-group">
      <button id="startOcr" class="btn btn-block btn-primary">Start OCR</button>
    </div>

  </div>

  <div id="ocrResultContainer" class="col-md-12 pt-2">
    <h3>Result</h3>
    <br>
    <textarea id="ocrText" class="form-control" style="width: 100%; height: 65vh; white-space: pre-wrap; font-family: monospace;"></textarea>
    <br>
    <button id="copyButton" class="btn btn-primary me-2" onclick="copyOcrText()">Copy to clipboard</button>
    <button id="downloadButton" class="btn btn-primary" onclick="downloadOcrText()">Download as .txt</button>
  </div>

</div><!-- /.container -->

<script>
const dz = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInputPdf');
dz.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => dz.textContent = fileInput.files[0].name);
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    window.selectedPdfFile = e.dataTransfer.files[0];
    dz.textContent = window.selectedPdfFile.name;
  }
});

const progressBar = document.getElementById("progressBar");
const progressContainer = document.getElementById("progressContainer");

function estimateProgress(file) {
  const estimatedPages = Math.max(1, Math.floor(file.size / (1024 * 100)));
  const estimatedTime = 22000 + Math.max(0, estimatedPages - 1) * 660;
  const startTime = Date.now();

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  progressBar.textContent = "0%";
  progressBar.setAttribute("aria-valuenow", "0");
  progressBar.classList.remove("zoom-bounce", "error-state", "progress-bar-striped", "active");
  progressBar.style.backgroundColor = "steelblue";

  const interval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(99, (elapsed / estimatedTime) * 100);
    const display = Math.floor(progress);
    progressBar.style.width = `${display}%`;
    progressBar.textContent = display >= 99 ? "99%..." : `${display}%`;
    progressBar.setAttribute("aria-valuenow", display);
  }, 300);

  return interval;
}

document.getElementById("startOcr").addEventListener("click", async function () {
  const pdfFile = fileInput.files[0] || window.selectedPdfFile;
  if (!pdfFile) return alert("Please upload a PDF.");

  const apiKey = document.getElementById("googleApiKey").value;
  if (!apiKey) return alert("API key is required.");

  const includePageNumbers = document.getElementById("includePageNumbers").checked;
  const displayInline = document.querySelector('input[name="display_style"]:checked').value === "yes";

  const formData = new FormData();
  formData.append("pdf_file", pdfFile);
  formData.append("google_api_key", apiKey);
  formData.append("include_page_numbers", includePageNumbers ? "yes" : "no");
  formData.append("display_style", displayInline ? "yes" : "no");

  const interval = estimateProgress(pdfFile);

  try {
    const res = await fetch("/ocr", {
      method: "POST",
      body: formData
    });

    if (!res.ok) throw new Error("OCR request failed.");

    clearInterval(interval);
    let display = parseFloat(progressBar.style.width);

    const fillInterval = setInterval(() => {
      display += 2;
      if (display >= 100) {
        display = 100;
        clearInterval(fillInterval);
        progressBar.style.width = "100%";
        progressBar.textContent = "100%";
        progressBar.setAttribute("aria-valuenow", 100);

        // Stop barber pole effect
        progressBar.classList.remove("progress-bar-striped", "active");

        // Zoom + green color effect
        progressBar.classList.remove("zoom-bounce");
        void progressBar.offsetWidth;
        progressBar.classList.add("zoom-bounce");
      } else {
        progressBar.style.width = `${display}%`;
        progressBar.textContent = `${Math.floor(display)}%`;
        progressBar.setAttribute("aria-valuenow", Math.floor(display));
      }
    }, 30);

    if (displayInline) {
    const raw = await res.text();
    const text = raw.replace(/<[^>]*>/g, '');
    const resultBox = document.getElementById("ocrResultContainer");

    setTimeout(() => {
      document.getElementById("ocrText").value = text;
      const resultBox = document.getElementById("ocrResultContainer");
      resultBox.style.display = "block";
      resultBox.classList.remove("animate-zoom");
      void resultBox.offsetWidth;
      resultBox.classList.add("animate-zoom");
    }, 700);
  } else {
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      const baseName = pdfFile ? pdfFile.name.replace(/\.pdf$/i, '') : 'ocr_result';
      link.download = `${baseName}_ocr_result.txt`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }
  } catch (err) {
    clearInterval(interval);
    progressBar.classList.add("error-state");
    progressBar.textContent = "Error";
    progressBar.setAttribute("aria-valuenow", 100);
    progressBar.style.width = "100%";
    progressBar.classList.remove("progress-bar-striped", "active");
  }
});

function copyOcrText() {
  const btn = document.getElementById("copyButton");
  const textArea = document.getElementById("ocrText");
  navigator.clipboard.writeText(textArea.value).then(() => {
    const originalText = btn.textContent;
    btn.textContent = "Copied!";
    btn.disabled = true;

    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 1200);
  });
}
</script>

</body>
</html>
