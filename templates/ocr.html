<!DOCTYPE html>
<html lang="en">
<head>
{% include 'head_default.html' %}
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
function downloadOcrText() {
  const text = document.getElementById("ocrText").value;
  const blob = new Blob([text], { type: 'text/plain' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ocr_result.txt";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

<style>
  .dropzone {
    border: 2px dashed #ccc; border-radius: 6px;
    padding: 40px; text-align: center;
    cursor: pointer; color: #777;
  }
  .dropzone.dragover { background: #f0f8ff; }
  #ocrResultContainer {
    margin-top: 3em;
    display: none;
    padding-bottom: 6em;
    transform-origin: top;
  }
  .animate-zoom {
    animation: zoomInActual 0.3s ease-out forwards;
  }
  @keyframes zoomInActual {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .zoom-bounce {
    animation: bounceFill 300ms ease-out forwards;
  }
  @keyframes bounceFill {
    0%   { transform: scaleY(1); background-color: steelblue; }
    50%  { transform: scaleY(1.2); background-color: mediumseagreen; }
    100% { transform: scaleY(1); background-color: mediumseagreen; }
  }
  .error-state {
    background-color: indianred !important;
  }
</style>
</head>

<body>

{% include 'nav.html' %}

<div class="container">
  <div class="col-md-6" id="ocrForm">

    <h1>PDF â†’ Google Vision OCR</h1>

    <!-- PDF input via drop zone -->
    <input type="file" id="fileInputPdf" accept=".pdf" style="display:none" required>
    <div class="dropzone" id="dropzone">
      <p>Drop a PDF here or click to select.</p>
    </div>

    <br>

    <!-- Google API key -->
    <div class="form-group">
      <label for="googleApiKey">
        Google Vision API key (required, see <a href="api_key_instructions" target="_blank">instructions</a>)
      </label>
      <input type="password" id="googleApiKey" class="form-control"
             placeholder="Enter your Google Vision API key"
             name="google_api_key" autocomplete="current-password" required>
    </div>

    <!-- Page number option -->
    <div class="form-group">
      <div class="checkbox">
        <label>
          <input type="checkbox" id="includePageNumbers" checked>
          Add extra page numbers in output (e.g. "=== 1 ===")
        </label>
      </div>
    </div>

    <!-- Display option -->
    <div class="form-group">
      <label>Where to get result:</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="display_inline" id="displayInline" value="yes" checked>
        <label class="form-check-label" for="displayInline">Show in browser</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="display_inline" id="downloadFile" value="no">
        <label class="form-check-label" for="downloadFile">Download file</label>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="progress" id="progressContainer" style="display: none;">
      <div class="progress-bar progress-bar-striped"
           id="progressBar"
           role="progressbar"
           aria-valuenow="0"
           aria-valuemin="0"
           aria-valuemax="100"
           style="width: 0%;">
        0%
      </div>
    </div>

    <p><button id="startOcr" class="btn btn-block btn-primary">Start OCR</button></p>

    <h2>Tips</h2>
    <p>
        Files up to <strong>~64 MB</strong> are accepted. Anything larger will error.<br>
        You may wish to crop the individual pages of your PDF to get more relevant results.<br>
        Google Vision OCR, like any OCR, makes mistakes. Be prepared to do some cleanup.<br>
        When uploading files, use ASCII-only filenames to avoid problems.
    </p>

    <div id="ocrResultContainer" class="pt-2">
      <h2>OCR Result</h2>
      <textarea id="ocrText" class="form-control mb-3" style="width: 100%; height: 85vh; white-space: pre-wrap; font-family: monospace;" readonly></textarea>
      <br>
      <button class="btn btn-primary mt-2 me-2" onclick="navigator.clipboard.writeText(document.getElementById('ocrText').value)">Copy to clipboard</button>
      <button class="btn btn-primary" onclick="downloadOcrText()">Download as .txt</button>
    </div>

  </div>
</div><!-- /.container -->

<script>
const dz = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInputPdf');
dz.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => dz.textContent = fileInput.files[0].name);
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    window.selectedPdfFile = e.dataTransfer.files[0];
    dz.textContent = window.selectedPdfFile.name;
  }
});

const progressBar = document.getElementById("progressBar");
const progressContainer = document.getElementById("progressContainer");

function estimateProgress(file) {
  const estimatedPages = Math.max(1, Math.floor(file.size / (1024 * 100)));
  const estimatedTime = 22000 + Math.max(0, estimatedPages - 1) * 660;
  const startTime = Date.now();

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  progressBar.textContent = "0%";
  progressBar.setAttribute("aria-valuenow", "0");
  progressBar.classList.remove("zoom-bounce", "error-state", "progress-bar-striped", "active");
  progressBar.style.backgroundColor = "steelblue";

  const interval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(99, (elapsed / estimatedTime) * 100);
    const display = Math.floor(progress);
    progressBar.style.width = `${display}%`;
    progressBar.textContent = display >= 99 ? "99%..." : `${display}%`;
    progressBar.setAttribute("aria-valuenow", display);
  }, 300);

  return interval;
}

document.getElementById("startOcr").addEventListener("click", async function () {
  const pdfFile = fileInput.files[0] || window.selectedPdfFile;
  if (!pdfFile) return alert("Please upload a PDF.");

  const apiKey = document.getElementById("googleApiKey").value;
  if (!apiKey) return alert("API key is required.");

  const includePageNumbers = document.getElementById("includePageNumbers").checked;
  const displayInline = document.querySelector('input[name="display_inline"]:checked').value === "yes";

  const formData = new FormData();
  formData.append("pdf_file", pdfFile);
  formData.append("google_api_key", apiKey);
  formData.append("include_page_numbers", includePageNumbers ? "yes" : "no");
  formData.append("display_inline", displayInline ? "yes" : "no");

  const interval = estimateProgress(pdfFile);

  try {
    const res = await fetch("/ocr", {
      method: "POST",
      body: formData
    });

    if (!res.ok) throw new Error("OCR request failed.");

    clearInterval(interval);
    let display = parseFloat(progressBar.style.width);

    const fillInterval = setInterval(() => {
      display += 2;
      if (display >= 100) {
        display = 100;
        clearInterval(fillInterval);
        progressBar.style.width = "100%";
        progressBar.textContent = "100%";
        progressBar.setAttribute("aria-valuenow", 100);

        // Stop barber pole effect
        progressBar.classList.remove("progress-bar-striped", "active");

        // Zoom + green color effect
        progressBar.classList.remove("zoom-bounce");
        void progressBar.offsetWidth;
        progressBar.classList.add("zoom-bounce");
      } else {
        progressBar.style.width = `${display}%`;
        progressBar.textContent = `${Math.floor(display)}%`;
        progressBar.setAttribute("aria-valuenow", Math.floor(display));
      }
    }, 30);

    if (displayInline) {
    const raw = await res.text();
    const text = raw.replace(/<[^>]*>/g, '');
    const resultBox = document.getElementById("ocrResultContainer");

    setTimeout(() => {
      document.getElementById("ocrText").value = text;
      const resultBox = document.getElementById("ocrResultContainer");
      resultBox.style.display = "block";
      resultBox.classList.remove("animate-zoom");
      void resultBox.offsetWidth;
      resultBox.classList.add("animate-zoom");
    }, 700);
  } else {
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ocr_result.txt";
      document.body.appendChild(link);
      link.click();
      link.remove();
    }
  } catch (err) {
    clearInterval(interval);
    progressBar.classList.add("error-state");
    progressBar.textContent = "Error";
    progressBar.setAttribute("aria-valuenow", 100);
    progressBar.style.width = "100%";
    progressBar.classList.remove("progress-bar-striped", "active");
  }
});
</script>

</body>
</html>
